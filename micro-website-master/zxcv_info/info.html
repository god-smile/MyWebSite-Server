<!-- 资讯管理 -->
<!-- 引入wangEditor插件 -->
<link rel="stylesheet" href="../common/wangEditor/wangEditor.min.css">
<script src="../common/wangEditor/wangEditor.min.js"></script>
<div>
    <div class="info-manage">
        <div class="info-action">
            <form class="form-inline info-select">
                <select class="form-control myselect"></select>
            </form>
            <button type="button" class="btn btn-success add-btn">新增</button>
            <button type="button" class="btn btn-primary badelete-btn">批量删除</button>
        </div>
        <!-- 表格 -->
        <div class="cate-table">
            <table class="table table-bordered text-center table-striped table-hover">
                <thead>
                    <tr>
                        <th class="text-center">编号</th>
                        <th class="text-center">资讯标题</th>
                        <th class="text-center">所属新闻类型</th>
                        <th class="text-center">排列方式</th>
                        <th class="text-center">作者</th>
                        <th class="text-center">发布时间</th>
                        <th class="text-center">阅读次数</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- 分页 -->
        <div class="page">
            <ul class="pagination"></ul>
        </div>
        <!-- 增加、修改模态框 -->
        <!--<div class="modal" id="add-update-modal" role="dialog">-->
            <!--<div class="modal-dialog" role="document">-->
                <!--<div class="modal-content">-->
                    <!--<div class="modal-header">-->
                        <!--<button type="button" class="close" data-dismiss="modal">-->
                            <!--<span>&times;</span>-->
                        <!--</button>-->
                        <!--<h4 class="modal-title"></h4>-->
                    <!--</div>-->
                    <!--<div class="modal-body">-->
                        <!--<form class="form-horizontal">-->
                            <!--<div class="form-group">-->
                                <!--<label for="title" class="col-md-2 control-label"> 标题</label>-->
                                <!--<div class="col-md-10">-->
                                    <!--<input id="title" type="text" class="form-control">-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="form-group">-->
                                <!--<label for="category" class="col-sm-2 control-label">所属新闻类型</label>-->
                                <!--<div class="col-md-10">-->
                                    <!--<select id="category" class="form-control"></select>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="form-group">-->
                                <!--<label class="col-sm-2 control-label">列表样式</label>-->
                                <!--<div class="col-md-5">-->
                                    <!--<label for="style-one">-->
                                        <!--<input type="radio" id="style-one" name="liststyle" value="style-one">-->
                                        <!--<img src="../common/images/style-one.jpg" alt="">-->
                                    <!--</label>-->
                                <!--</div>-->
                                <!--<div class="col-md-5">-->
                                    <!--<label for="style-two">-->
                                        <!--<input type="radio" id="style-two" name="liststyle" value="style-two">-->
                                        <!--<img src="../common/images/style-two.jpg" alt="">-->
                                    <!--</label>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="form-group">-->
                                <!--<label for="content" class="col-md-2 control-label"> 正文</label>-->
                                <!--<div class="col-md-10">-->
                                    <!--<textarea id="content" type="text" class="form-control">-->
                                    <!--</textarea>-->
                                <!--</div>-->
                            <!--</div>-->
                        <!--</form>-->
                    <!--</div>-->
                    <!--<div class="modal-footer">-->
                        <!--<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>-->
                        <!--<button id="to-save" type="button" class="btn btn-primary">确定</button>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <div class="modal" id="add-update-modal" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="title" class="col-md-2 control-label"> 标题</label>
                                <div class="col-md-10">
                                    <input id="title" type="text" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="category" class="col-sm-2 control-label">所属新闻类型</label>
                                <div class="col-md-10">
                                    <select id="category" class="form-control"></select>
                                </div>
                            </div>

                            <div class="form-group">
                                <div id="editor_add">

                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button id="to-save" type="button" class="btn btn-primary">确定</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script>
    //需要用到的数据
    var state = {
        //当前页数
        currentPage: 1,
        //总的数据个数
        total: 0,
        //每页个数
        pageSize: 8,
        //总页数
        totalPage: 0,
        //表格数据
        tableData: [],
        //表格总数据
        tableTotalData: [],
        //所有的新闻类型信息
        category: [],
        //当前操作类型：新增或修改
        option: '发布',
        //当前点击的对象的id
        currentId: '',
        //当前info-action中select选中的栏目id
        currentCId: '',
        // 当前修改的对象
        currentObj: {},
    };
    addCategory();
    //当currentCId发生改变时，获取对应新闻类型的资讯信息
    $('.myselect').change(function() {
        state.currentCId = $(this).val();
        findArticle(state.currentCId);
    });
    //分页事件绑定
    $('.pagination').on('click', 'li', function(event) {
        //如果有禁用，直接返回
        if ($(this).hasClass('disabled')) {
            return;
        }
        //点击页码
        if ($(this).hasClass('page-num')) {
            state.currentPage = +($(this).text());
            $('.pagination li').removeClass('active');
            $(this).addClass('active');
            if (state.currentPage == 1) {
                $('.pagination li:first-child').addClass('disabled');
            } else {
                $('.pagination li:first-child').removeClass('disabled');
            }
            if (state.currentPage == state.totalPage) {
                $('.pagination li:last-child').addClass('disabled');
            } else {
                $('.pagination li:last-child').removeClass('disabled');
            }
        }
        //点击上一页
        if ($(this).hasClass('prev')) {
            state.currentPage -= 1;
            //设置上一个li为选中状态
            $('.pagination li').removeClass('active');
            $('.pagination li').eq(state.currentPage).addClass('active');
            if (state.currentPage == 1) {
                $(this).addClass('disabled');
            }
            if (state.currentPage != state.totalPage) {
                $('.pagination .next').removeClass('disabled');
            }
        }
        //点击下一页
        if ($(this).hasClass('next')) {
            state.currentPage += 1;
            // 设置下一个的li为选中状态
            $('.pagination li').removeClass('active');
            $('.pagination li').eq(state.currentPage).addClass('active');
            if (state.currentPage == state.totalPage) {
                $(this).addClass('disabled');
            }
            if (state.currentPage != 1) {
                $('.pagination .prev').removeClass('disabled');
            }
        }
        //访问数据，每点击一次li就需要访问相应页码的数据，此处实现页码和表格数据一一对应
        state.tableData = state.tableTotalData.slice((state.currentPage - 1) * state.pageSize, state.currentPage * state.pageSize);
        //追加节点
        addTableDOM();
    });
    //点击模态框的保存
    //区分新增和修改，修改的时候需要额外传递当前修改的对象的id
    $('#to-save').click(function(event) {
        //获取值
        var title = $('#title').val();
        //当前模态框中select选中的所属新闻类型的id
        var categoryId = $('#category').val();
        var liststyle = $('input[type=radio]:checked').val();
        var content = $('#content').val();
        console.log(title, categoryId, liststyle, content);
        if (title && categoryId && liststyle && content) {
            var obj = {
                title: title,
                categoryId: categoryId,
                liststyle: liststyle,
                content: content
            };
            if (state.option == '编辑') {
                obj.id = state.currentObj.id;
                obj.publishtime = parseDate();
                obj.readtimes = state.currentObj.readtimes;
            }
            console.log('传递给后台的数据是：', obj);
            // 提交数据给后台
            saveOrUpdateArticle(obj);
        } else {
            alert('请输入完整的信息');
        }
    });
    //新增事件绑定
    $('.add-btn').click(function(event) {
        // 设置option
        state.option = '发布';
        //设置模态框标题
        $('.modal-title').text(state.option + '资讯');
        //追加模态框的select
        addOptionDOM();
        // 清空表单数据，显示模态框
        $('.modal [type=text]').val('');
        $('input[type=radio]:checked').prop('checked', false);
        //模态框中的select的值为.myselect的值
        $('#category').val($('.myselect').val());
        //加载编辑正文
        fun.addFun();
        $('#add-update-modal').modal('show');
    });
    //修改事件绑定
    $('tbody').on('click', '[title=编辑]', function() {
        state.option = '编辑';
        //设置模态框标题
        $('.modal-title').text(state.option + '资讯');
        addOptionDOM();
        //获取当前点击的元素的id
        var id = $(this).attr('data_id');
        //遍历数据，如果当前id与遍历的id同，取出需要的属性值
        var article = state.tableData.filter(function(item) {
            return item.id == id;
        })[0];
        state.currentObj = article;
        // 设置值
        $('#title').val(article.title);
        //模态框中的select的值为.myselect的值
        $('#category').val($('.myselect').val());
        $('input[value=' + article.liststyle + ']').prop('checked', true);
        $('#content').val(article.content);
        $('#add-update-modal').modal('show');
    });
    //通过id删除事件绑定
    $('tbody').on('click', '[title=删除]', function() {
        deleteArticleById($(this).attr('data_id'));
    });
    //批量删除事件绑定
    $('.badelete-btn').click(function(event) {
        //获取用户选中的input
        var checked = Array.from($('input[type=checkbox]:checked'));
        if (checked.length > 0) {
            var ids = checked.map(function(item, index) {
                return $(item).attr('value');
            });
            batchDeleteArticle(ids);
        } else {
            alert('请选择要删除的数据');
        }
    });
    //获取所有新闻类型，追加节点到select中
    function addCategory() {
        getAjax('/manager/category/findAllCategory', 'get', null, function(res) {
            state.category = res.data;
            var option = '';
            state.category.forEach(function(item) {
                option += `<option value="` + item.id + `">` + item.name + `</option>`;
            });
            $('.myselect').html(option);
            state.currentCId = res.data[0].id;
            //加载当前select中对应的资讯信息,也是第一个
            findArticle(state.currentCId);
        }, function(error) {
            console.log(error);
        });
    }
    // 通过新闻类型id加载对应的资讯信息
    function findArticle(CId) {
        var obj = {
            //页数，每次渲染从第一页开始
            page: 0,
            //TODO
            pageSize: 100,
            //当前select中栏目的id即currentCId
            categoryId: CId
        };
        //重置分页器
        $('.pagination li').removeClass('active');
        $('.pagination li.page-num:first-child').addClass('active');
        $('.pagination li:first-child').addClass('disabled');
        state.currentPage = 1;
        state.tableData = [];
        getAjax('/manager/article/findArticle', 'get', obj, function(res) {
            //console.log(res.data.list);
            state.total = res.data ? res.data.list.length : 0;
            state.totalPage = Math.ceil(state.total / state.pageSize);
            state.tableTotalData = res.data ? res.data.list : [];
            //追加分页数据
            addPageDOM();
            //追加表格数据
            if (state.tableTotalData.length > 0) {
                //获取数据的第几页的数据
                state.tableData = state.tableTotalData.slice((state.currentPage - 1) * state.pageSize, state.currentPage * state.pageSize);
            }
            addTableDOM();
        }, function(error) {
            console.log(error);
        });
    }
    //遍历当前页的数据，给其追加表格DOM
    function addTableDOM() {
        var str = '';
        state.tableData.forEach(function(item) {
            str += ` <tr>
                            <td><input type="checkbox" value="` + item.id + `"/></td>
                            <td>` + item.title + `</td>
                            <td>` + (item.category ? item.category.name : '-') + `</td>
                            <td>` + item.liststyle + `</td>   
                            <td>` + (item.author ? item.author : '-') + `</td>
                            <td>` + item.publishtime + `</td>
                            <td>` + item.readtimes + `</td>         
                            <td>
                                <i data_id="` + item.id + `" title="编辑" class="fa fa-pencil-square-o" aria-hidden="true"></i>
                                <i data_id="` + item.id + `"  title="删除" class="fa fa-trash-o" aria-hidden="true"></i>
                            </td>
                        </tr>`;
        });
        $('tbody').html(str);
    }
    //追加分页DOM
    function addPageDOM() {
        var pageStr = `<li class="prev">
              <a href="#">
                <span>&laquo;</span>
              </a>
            </li>`;
        for (var i = 0; i < state.totalPage; i++) {
            pageStr += `<li class="page-num"><a href="#">` + (i + 1) + `</a></li>`;
        }
        pageStr += `<li class="next">
              <a href="#">
                <span>&raquo;</span>
              </a>
            </li>`;
        $('.pagination').html(pageStr);
        $('.pagination .page-num:first').addClass('active');
    }
    //追加模态框处所属栏目的option节点
    function addOptionDOM() {
        var optionStr = `<option value="">请选择</option>`;
        state.category.forEach(function(item) {
            optionStr += `<option value="` + item.id + `">` + item.name + `</option>`;
        });
        $('#category').html(optionStr);
    }
    //保存数据
    function saveOrUpdateArticle(obj) {
        getAjax('/manager/article/saveOrUpdateArticle', 'post', obj,
            function(res) {
                if (res.status == 200) {
                    // 提交成功的回调函数里，更新数据，关闭模态框。
                    findArticle(state.currentCId);
                    $('#add-update-modal').modal('hide');
                }
            },
            function(error) {
                console.log(error);
            });
    }
    //通过id删除数据
    function deleteArticleById(id) {
        getAjax('/manager/article/deleteArticleById', 'get', { id: id },
            function(res) {
                if (res.status == 200) {
                    alert('删除成功');
                    findArticle(state.currentCId);
                }
            },
            function(error) {
                console.log(error);
            });
    }
    //批量删除数据
    function batchDeleteArticle(ids) {
        getAjax('/manager/article/batchDeleteArticle', 'post', { ids: ids.toString() },
            function(res) {
                if (res.status == 200) {
                    alert('批量删除成功');
                    findArticle(state.currentCId);
                }
            },
            function(error) {
                console.log(error);
            });
    }
    //返回当前时间的函数,每进行一次修改，时间就会发生变化
    function parseDate() {
        var date = new Date();
        console.log(date);
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        month = addZero(month);
        var day = date.getDate();
        day = addZero(day);
        var hours = date.getHours();
        hours = addZero(hours);
        var minutes = date.getMinutes();
        minutes = addZero(minutes);
        var seconds = date.getSeconds();
        seconds = addZero(seconds);
        return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }
    function addZero(num) {
        return num < 10 ? '0' + num : num;
    }


    var fun = {
        addFun: function () {
            //清空
            $("#editor_add").empty();
            var E = window.wangEditor;
            var editor = new E('#editor_add');
            // 自定义菜单配置
            editor.customConfig.menus = [
                'head',  // 标题
                'bold',  // 粗体
                'fontSize',  // 字号
                // 'fontName',  // 字体
                'italic',  // 斜体
                'underline',  // 下划线
                'strikeThrough',  // 删除线
                'foreColor',  // 文字颜色
                'backColor',  // 背景颜色
                'link',  // 插入链接
                'list',  // 列表
                'justify',  // 对齐方式
                'quote',  // 引用
                'emoticon',  // 表情
                'image',  // 插入图片
                'table',  // 表格
                // 'video',  // 插入视频
                'code',  // 插入代码
                'undo',  // 撤销
                'redo'  // 重复
            ];
            // editor.customConfig.uploadImgServer = '/Upload/wang_editor';  // 上传图片到服务器
            //editor.customConfig.uploadImgServer = '/upload';
            editor.customConfig.uploadImgShowBase64 = true;   // 使用 base64 保存图片
            // 3M
            editor.customConfig.uploadImgMaxSize = 3 * 1024 * 1024;
            // 限制一次最多上传 3 张图片
            editor.customConfig.uploadImgMaxLength = 3;
            // 自定义文件名
            editor.customConfig.uploadFileName = 'editor_img';
            // 将 timeout 时间为 3s
            editor.customConfig.uploadImgTimeout = 3000;

            editor.create();
            editor.customConfig.uploadImgHooks = {
                before: function (xhr, editor, files) {
                    // 图片上传之前触发
                    // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，files 是选择的图片文件

                    // 如果返回的结果是 {prevent: true, msg: 'xxxx'} 则表示用户放弃上传
                    // return {
                    //     prevent: true,
                    //     msg: '放弃上传'
                    // }
                    // alert("前奏");
                },
                success: function (xhr, editor, result) {
                    // 图片上传并返回结果，图片插入成功之后触发
                    // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，result 是服务器端返回的结果
                    // var url = result.data.url;
                    // alert(JSON.stringify(url));
                    // editor.txt.append(url);
                    // alert("成功");
                },
                fail: function (xhr, editor, result) {
                    // 图片上传并返回结果，但图片插入错误时触发
                    // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，result 是服务器端返回的结果
                    alert("失败");
                },
                error: function (xhr, editor) {
                    // 图片上传出错时触发
                    // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象
                    // alert("错误");
                },
                // 如果服务器端返回的不是 {errno:0, data: [...]} 这种格式，可使用该配置
                // （但是，服务器端返回的必须是一个 JSON 格式字符串！！！否则会报错）
                customInsert: function (insertImg, result, editor) {
                    // 图片上传并返回结果，自定义插入图片的事件（而不是编辑器自动插入图片！！！）
                    // insertImg 是插入图片的函数，editor 是编辑器对象，result 是服务器端返回的结果
                    // 举例：假如上传图片成功后，服务器端返回的是 {url:'....'} 这种格式，即可这样插入图片：
                    var url = result.data[0];
                    insertImg(url);
                    // result 必须是一个 JSON 格式字符串！！！否则报错
                }
            }


            //获取文本输入的内容
            /*document.getElementById('editor_submit').addEventListener('click', function () {
                var content = editor.txt.html();
                var noticeTitle = $('#arcitleTit').val();
                var noticeType = $('#msgTypeadd').val();
                var effDate = $('#daydaterange-btnstaadd').val() + ' 00:00:00';
                var expireDate = $('#daydaterange-btnendadd').val() + ' 23:59:59';

                effDate = new Date(effDate.replace(/-/g, '/'));
                expireDate = new Date(expireDate.replace(/-/g, '/'));


                var req = {
                    noticeTitle: noticeTitle,
                    noticeBigType: noticeType,
                    noticeType: noticeType,
                    remoteStorage: true,
                    addressType: 1,
                    effDate: effDate,
                    expireDate: expireDate,
                    noticeContent: content,
                    fileExt: "txt"

                };
                //条件查询

                req.sysCode = sysComm.sysCode;
                var opt = {
                    method: 'post',
                    url: dataUrl.util.saveNotice(),
                    data: JSON.stringify(req),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == '8888') {
                            // fun.createTableData();
                            $("#msg_recordtable").bootstrapTable('refresh');
                            $('.editor-content').addClass('display-none');
                            $('.normal-content').removeClass('display-none');

                        }
                    },
                    error: function (msg) {
                        alert("ajax连接异常：" + msg);
                    }
                };
                sysAjax(opt);


            }, false)*/

        },
    }
    </script>
</div>